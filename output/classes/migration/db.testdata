INSERT INTO ingredient(name, unit)
VALUES ('Saucisse', 'G'),
       ('Huile', 'L'),
       ('Oeuf', 'U'),
       ('Pain', 'U');

INSERT INTO ingredient_price_history(id_ingredient, date_price, unit_price)
VALUES (1, '2025-01-01', 20),
       (2, '2025-01-01', 10000),
       (3, '2025-01-01', 1000),
       (4, '2025-01-01', 1000);

INSERT INTO dish(name, unit_price)
VALUES ('HOT dog', 15000);

INSERT INTO dish_ingredient(id_dish, id_ingredient, quantity, unit)
VALUES (1, 1, 100, 'G'),
       (1, 2, 0.15, 'L'),
       (1, 3, 1, 'U'),
       (1, 4, 1, 'U');

SELECT
    ingredient.name AS name,
    ingredient_price_history.unit_price AS unit_price
FROM ingredient
INNER JOIN ingredient_price_history ON ingredient_price_history.id_ingredient = ingredient.id_ingredient
WHERE ingredient.name ILIKE '%U%'
AND unit_price <= 1000
ORDER BY name ASC, unit_price DESC;

SELECT
    ingredient.name AS name,
    ingredient_price_history.unit_price AS unit_price FROM ingredient
INNER JOIN ingredient_price_history ON ingredient_price_history.id_ingredient = ingredient.id_ingredient
WHERE ingredient.name ILIKE '%U%'
AND unit_price <= 1000
ORDER BY name ASC, unit_price DESC
LIMIT 1 OFFSET 0;

SELECT
    dish.name AS dish_name,
    ingredient.name AS ingredient_name,
    dish_ingredient.quantity AS quantity,
    ingredient_price_history.unit_price AS unit_price
FROM dish_ingredient
INNER JOIN dish ON dish_ingredient.id_dish = dish.id_dish
INNER JOIN ingredient ON dish_ingredient.id_ingredient = ingredient.id_ingredient
INNER JOIN ingredient_price_history ON ingredient_price_history.id_ingredient = ingredient.id_ingredient
    AND ingredient_price_history.date_price = (
        SELECT MAX(date_price)
        FROM ingredient_price_history
        WHERE id_ingredient = ingredient.id_ingredient
    )
WHERE dish.id_dish=1;